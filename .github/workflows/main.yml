name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # 1. ИСПРАВЛЕНИЕ ИМЕНИ ПАПКИ
    # Мы создаем папку "exam_app" (начинается с буквы!) и переносим всё туда.
    # Так мы избегаем ошибки "name: 7211_exam".
    - name: Prepare Valid Project Structure
      run: |
        mkdir exam_app
        
        # Копируем главный файл
        cp main.py exam_app/
        
        # Создаем assets внутри новой папки
        mkdir -p exam_app/assets
        if [ -f questions.json ]; then cp questions.json exam_app/assets/; fi
        if [ ! -f exam_app/assets/questions.json ]; then echo "{}" > exam_app/assets/questions.json; fi
        
        # Создаем requirements.txt внутри новой папки
        echo "flet==0.25.2" > exam_app/requirements.txt

    # 2. Java 17
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 3. Flutter (ОБНОВИЛИ ДО 3.24.0, как просила ошибка)
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'

    # 4. Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # 5. Установка Flet
    - name: Install Dependencies
      run: |
        pip uninstall -y flet flet-cli || true
        pip install cookiecutter
        pip install flet==0.25.2

    # 6. Лицензии
    - name: Accept Licenses
      run: |
        yes | flutter doctor --android-licenses

    # 7. СБОРКА ИЗ ПРАВИЛЬНОЙ ПАПКИ
    # Мы заходим в папку exam_app (cd exam_app) и запускаем сборку там.
    - name: Build APK
      run: |
        cd exam_app
        flet build apk . --verbose

    # 8. Загрузка файла
    # Обрати внимание: путь изменился, теперь файл лежит внутри exam_app
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: exam_app/build/apk/app-release.apk
